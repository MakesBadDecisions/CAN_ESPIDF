# ui — LVGL User Interface (SquareLine Studio + Custom Logic)

## Purpose

Contains all LVGL screen definitions, widget layouts, and custom event logic.
Screen layouts (`ui_Screen1.c`, `ui_Screen2.c`, `ui.c`, `ui_helpers.c`, `ui_comp_hook.c`)
are generated by **SquareLine Studio 1.5.3** and should NOT be hand-edited.

All custom behavior lives in `ui_events.c` / `ui_events.h`.

## File Overview

| File | Source | Purpose |
|------|--------|---------|
| `ui.c` | SquareLine | Root UI init, screen creation |
| `ui.h` | SquareLine | Widget extern declarations |
| `ui_Screen1.c` | SquareLine | Main gauge screen — 4 gauge slots, PID/unit dropdowns, connect/poll/settings buttons, status label, VIN label |
| `ui_Screen2.c` | SquareLine | Settings screen — brightness slider/label, back button, WiFi AP button, system panel, color wheel panel |
| `ui_helpers.c` | SquareLine | Animation helpers, screen change, slider text value setter |
| `ui_comp_hook.c` | SquareLine | Component hook utilities |
| `ui_events.c` | **Custom** | All event handlers, gauge wiring, theme system, brightness control, colorwheel, IMU display attach/detach |
| `ui_events.h` | **Custom** | Public API for event system (must be re-fixed after every SquareLine re-export) |

## Custom Event System (ui_events.c)

### Initialization

- `ui_events_post_init()` — Called from `main.c` after `ui_init()`. Registers:
  - `settingsButton` as additional `LV_EVENT_CLICKED` callback on `ui_settingsButton`
  - Status label creation and polling timer
  - This is the SquareLine-safe entry point (never edits generated files)

### Screen1 Events

- `connectCAN(e)` — Trigger vehicle scan or recall saved vehicle info
- `pollCAN(e)` — Start/stop CAN polling (toggle), starts/stops data logger
- `on_pid_changed(e)` — PID dropdown changed → update gauge_engine slot, rebuild poll list, handle IMU uniqueness
- `on_unit_changed(e)` — Unit dropdown changed → update gauge_engine display unit, handle IMU mode switch
- `gauge_update_cb()` — 100ms LVGL timer: reads gauge_engine values, updates gauge labels, logs data row

### Screen2 Events (Settings)

- `settingsButton(e)` — Stops polling, creates 200ms deferred timer for Screen2 init
- `settings_screen_deferred_init()` — One-shot timer callback → `settings_screen_init_values()`
- `settings_screen_init_values()` — Runs after Screen2 transition completes:
  - Sets brightness slider to current `display_get_brightness()` value
  - Registers `on_brightness_changed` callback (LV_EVENT_VALUE_CHANGED)
  - Creates colorwheel dynamically inside `ui_colorWhellPanel`
  - Restores saved color with saturation guard (HSV S < 20 → default blue)
  - Registers `on_colorwheel_changed` callback
  - Applies theme color to all Screen2 widgets

### Brightness

- `on_brightness_changed(e)` — Reads slider value → `display_set_brightness()` → updates label text

### Theme Color System

- `on_colorwheel_changed(e)` — Reads RGB from wheel → updates hex label → `ui_apply_theme_color()` → `ui_save_theme_color()`
- `ui_apply_theme_color(uint16_t color_raw)` — Applies to ALL widgets across both screens:
  - **Labels** → `lv_obj_set_style_text_color()` (gauge text, info labels, settings labels)
  - **Buttons/Panels/Gauges** → `lv_obj_set_style_border_color()` (interactive widgets, gauge borders)
  - **Dropdowns** → both text color and border color
- `ui_save_theme_color(uint16_t)` — NVS write to `"display"` / `"theme"` (uint16 RGB565)
- `ui_load_theme_color()` — NVS read, returns stored color or `THEME_COLOR_DEFAULT` (0x34DB, blue)

## SquareLine Re-Export Checklist

After ANY SquareLine re-export, these files are overwritten and must be fixed:

1. **`ui_events.h`**: Re-add:
   ```c
   #include "lvgl.h"
   void settingsButton(lv_event_t *e);
   void ui_events_post_init(void);
   void ui_apply_theme_color(uint16_t color_raw);
   void ui_save_theme_color(uint16_t color_raw);
   uint16_t ui_load_theme_color(void);
   ```

2. **`CMakeLists.txt`**: Restore to `idf_component_register()` format:
   ```cmake
   idf_component_register(
       SRCS "ui.c" "ui_Screen1.c" "ui_Screen2.c" "ui_helpers.c"
            "ui_comp_hook.c" "ui_events.c"
       INCLUDE_DIRS "."
       REQUIRES lvgl gauge_engine comm_link display_driver
                imu_display data_logger boot_splash nvs_flash
   )
   ```
   SquareLine replaces this with raw `add_library()` which breaks ESP-IDF component resolution.

3. **`ui_Screen2.c`**: Verify new file includes all expected widgets (`ui_brightnessSlider`, `ui_colorWhellPanel`, etc.)

## NVS Keys

| Namespace | Key | Type | Default | Purpose |
|-----------|-----|------|---------|---------|
| `display` | `theme` | u16 | 0x34DB | Theme color (RGB565) |

Brightness is persisted by `display_driver`, not by the ui component.

## Dependencies

- `lvgl` — Graphics library
- `gauge_engine` — Gauge slot data management
- `comm_link` — UART communication, PID data store
- `display_driver` — `display_set_brightness()` / `display_get_brightness()` API
- `imu_display` — IMU bubble attach/detach for virtual PID slots
- `data_logger` — Session start/stop from pollCAN()
- `boot_splash` — Splash duration config
- `nvs_flash` — Theme color persistence
